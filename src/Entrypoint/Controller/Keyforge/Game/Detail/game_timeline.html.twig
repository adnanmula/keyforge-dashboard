{% block header %}
    <style>
        .timeline {
            position: relative;
            max-width: 800px;
            margin: auto;
            padding: 20px 0;
        }

        .timeline::after {
            content: '';
            position: absolute;
            width: 4px;
            background-color: #999;
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -2px;
        }

        .timeline-item {
            padding: 20px 30px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }

        .timeline-item::after {
            content: ' ';
            position: absolute;
            width: 20px;
            height: 20px;
            right: -10px;
            background-color: white;
            border: 4px solid #ff9f55;
            top: 20px;
            border-radius: 50%;
            z-index: 1;
        }

        .timeline-item.left {
            left: 0;
        }

        .timeline-item.right {
            left: 50%;
        }

        .timeline-item.right::after {
            left: -10px;
        }

        .timeline-content {
            padding: 20px;
            background-color: white;
            position: relative;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .timeline-content h3 {
            margin-top: 0;
        }

        .timeline-content ul {
            padding-left: 20px;
            margin: 10px 0 0 0;
        }

        .timeline-user {
            display: none;
        }

        @media screen and (max-width: 600px) {
            .timeline::after {
                left: 31px;
            }

            .timeline-item {
                width: 100%;
                padding-left: 70px;
                padding-right: 25px;
            }

            .timeline-item.right {
                left: 0;
            }

            .timeline-item.right::after,
            .timeline-item.left::after {
                left: 15px;
            }

            .timeline-user {
                display: block;
            }
        }
    </style>
{% endblock %}

<div class="row">
    <div class="col-6"><h5 style="text-align:right;" id="fullTimelinePlayer1">{{ log.player1.name }}</h5></div>
    <div class="col-6"><h5 style="text-align:left;" id="fullTimelinePlayer2">{{ log.player2.name }}</h5></div>
    <div class="col-12 mt-2 mb-3">
        <select class="form-select" name="eventType" id="timelineEventTypeSelect" multiple>
            <option value="AMBER_OBTAINED">{{ 'game.timeline.AMBER_OBTAINED'|trans }}</option>
            <option value="CARDS_DISCARDED">{{ 'game.timeline.CARDS_DISCARDED'|trans }}</option>
            <option value="CARDS_DRAWN">{{ 'game.timeline.CARDS_DRAWN'|trans }}</option>
            <option value="CARDS_PLAYED">{{ 'game.timeline.CARDS_PLAYED'|trans }}</option>
            <option value="HOUSE_CHOSEN">{{ 'game.timeline.HOUSE_CHOSEN'|trans }}</option>
            <option value="KEY_FORGED">{{ 'game.timeline.KEY_FORGED'|trans }}</option>
            <option value="FIGHT">{{ 'game.timeline.FIGHT'|trans }}</option>
            <option value="REAP">{{ 'game.timeline.REAP'|trans }}</option>
            <option value="CARD_USED">{{ 'game.timeline.CARD_USED'|trans }}</option>
            <option value="AMBER_STOLEN">{{ 'game.timeline.AMBER_STOLEN'|trans }}</option>
            <option value="EXTRA_TURN">{{ 'game.timeline.EXTRA_TURN'|trans }}</option>
            <option value="TOKEN_CREATED">{{ 'game.timeline.TOKEN_CREATED'|trans }}</option>
            <option value="PROPHECY_ACTIVATED">{{ 'game.timeline.PROPHECY_ACTIVATED'|trans }}</option>
            <option value="PROPHECY_FULFILLED">{{ 'game.timeline.PROPHECY_FULFILLED'|trans }}</option>
            <option value="FATE_RESOLVED">{{ 'game.timeline.FATE_RESOLVED'|trans }}</option>
            <option value="TIDE_RAISED">{{ 'game.timeline.TIDE_RAISED'|trans }}</option>
            <option value="CHAINS_ADDED">{{ 'game.timeline.CHAINS_ADDED'|trans }}</option>
            <option value="CHAINS_REDUCED">{{ 'game.timeline.CHAINS_REDUCED'|trans }}</option>
            <option value="CHECK_DECLARED">{{ 'game.timeline.CHECK_DECLARED'|trans }}</option>
            <option value="PLAYER_CONCEDED">{{ 'game.timeline.PLAYER_CONCEDED'|trans }}</option>
        </select>
    </div>
    <div class="timeline" id="timeline"></div>
</div>

<script>
    const fullTimelineEvents = {{ log.timeline|json_encode|raw }};
    const fullTimelineEventsGrouped = [];

    fullTimelineEvents.forEach(entry => {
        const key = `${entry.player}|${entry.turn.value}`;
        if (!fullTimelineEventsGrouped[key]) {
            fullTimelineEventsGrouped[key] = [];
        }

        fullTimelineEventsGrouped[key].push(entry);
    });

    const timeline = document.getElementById('timeline');

    Object.keys(fullTimelineEventsGrouped).forEach(key => {
        const turnEntry = fullTimelineEventsGrouped[key];

        let actions = [];
        Object.keys(turnEntry).forEach(key2 => {
            const event = turnEntry[key2];
            switch (event.type) {
                case 'CARDS_PLAYED':
                    event.value.forEach(card => {
                        actions.push('<span data-type="'+event.type+'">{{ 'menu.played'|trans }} ' + card + '</span>');
                    });
                    break;

                case 'KEY_FORGED':
                    actions.push('<span data-type="'+event.type+'">{{ 'menu.key_forged'|trans }}: ' + event.value + ' {{ 'menu.cost'|trans }}: ' + event.payload.amberCost + ' {{ 'menu.remaining'|trans }}: ' + event.payload.amberRemaining + '</span>');
                    break;

                case 'CARDS_DISCARDED':
                    actions.push('<span data-type="'+event.type+'">{{ 'menu.cards_discarded'|trans }}: ' + event.value + '</span>');
                    break;

                case 'CARDS_DRAWN':
                    actions.push('<span data-type="'+event.type+'">{{ 'menu.cards_drawn'|trans }}: ' + event.value + '</span>');
                    break;

                case 'AMBER_OBTAINED':
                    actions.push('<span data-type="'+event.type+'">{{ 'menu.current_amber'|trans }}: ' + event.value + ' (delta: ' + event.payload.delta + ')</span>');
                    break;

                case 'HOUSE_CHOSEN':
                    actions.push('<span data-type="'+event.type+'">{{ 'menu.house_chosen'|trans }}: ' + event.value + ')</span>');
                    break;

                case 'AMBER_STOLEN':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.used'|trans }} ' + event.payload.trigger + ' {{ 'game.timeline.to_steal'|trans|lower }} ' + event.value + ' {{ 'game.timeline.amber'|trans|lower }}' + '</span>');
                    break;

                case 'FIGHT':
                    if (event.payload.trigger === event.value) {
                        actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.fought_with'|trans }} ' + event.value + ' {{ 'game.timeline.versus'|trans|lower }} ' + event.payload.target + '</span>');
                    } else {
                        actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.used'|trans }} ' + event.payload.trigger + ' {{ 'game.timeline.to_fight_with'|trans|lower }} ' + event.value + ' {{ 'game.timeline.versus'|trans|lower }} ' + event.payload.target + '</span>');
                    }
                    break;

                case 'REAP':
                    if (event.payload.trigger === event.value) {
                        actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.reaped_with'|trans }} ' + event.value + '</span>');
                    } else {
                        actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.used'|trans }} ' + event.payload.trigger + ' {{ 'game.timeline.to_reap_with'|trans|lower }} ' + event.value + '</span>');
                    }
                    break;

                case 'EXTRA_TURN':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.used'|trans }} ' + event.payload.trigger + ' {{ 'game.timeline.extra_turn'|trans|lower }}' + '</span>');
                    break;

                case 'TIDE_RAISED':
                    if ('manual' === event.value) {
                        actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.manually_raised_tide'|trans }}' + '</span>');
                    } else {
                        actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.used'|trans }} ' + event.value + ' {{ 'game.timeline.to_raise_tide'|trans|lower }}' + '</span>');
                    }
                    break;

                case 'TOKEN_CREATED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.used'|trans }} ' + event.value + ' {{ 'game.timeline.to_make_token'|trans|lower }}' + '</span>');
                    break;

                case 'PROPHECY_ACTIVATED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.activates'|trans }} {{ 'game.timeline.the_prophecy'|trans|lower }} ' + event.value + '</span>');
                    break;

                case 'PROPHECY_FULFILLED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.fulfilled'|trans }} {{ 'game.timeline.the_prophecy'|trans|lower }} ' + event.value + '</span>');
                    break;

                case 'FATE_RESOLVED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.resolved'|trans }} {{ 'game.timeline.the_fate_of'|trans|lower }} ' + event.value + '</span>');
                    break;

                case 'CHAINS_ADDED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.added_chains'|trans({'%by%': '-replace1-', '%reason%': '-replace2-'}) }}' + '</span>'
                        .replace('-replace1-', event.value)
                        .replace('-replace2-', event.payload.trigger));
                    break;

                case 'CHAINS_REDUCED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.reduced_chains'|trans({'%by%': '-replace1-', '%to%': '-replace2-'}) }}' + '</span>'
                        .replace('-replace1-', event.value)
                        .replace('-replace2-', event.payload.currentChains));
                    break;

                case 'CHECK_DECLARED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.check'|trans }}' + '</span>');
                    break;

                case 'PLAYER_CONCEDED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.conceded'|trans }}' + '</span>');
                    break;

                case 'CARD_USED':
                    actions.push('<span data-type="'+event.type+'">{{ 'game.timeline.used'|trans }} ' + event.value + ' {{ 'game.timeline.to'|trans|lower }} ' + event.payload.effect + '</span>');
                    break;
            }
        })

        const player = key.split('|')[0];
        const turn = key.split('|')[1];
        const side = player === '{{ log.player1.name }}' ? 'left' : 'right';
        const turnLabel = '{{ 'menu.turn'|trans }} ' + turn;

        const item = document.createElement('div');
        item.className = `timeline-item ${side}`;
        const content = document.createElement('div');
        content.className = 'timeline-content';

        content.innerHTML = `
          <h5 class="timeline-user">${player}</h5>
          <h5>${turnLabel}</h5>
          <span>${actions.join("<hr style='margin: 0.2rem'>")}</span>
        `;

        item.appendChild(content);
        timeline.appendChild(item);
    });

    $(document).ready(function() {
        $('#timelineEventTypeSelect').select2({
            minimumResultsForSearch: 0,
            minimumInputLength: 0,
            multiple: true,
            closeOnSelect: true,
            allowClear: true,
            placeholder: '{{ 'menu.filter_event_type'|trans }}',
            theme: 'bootstrap-5',
        });

        $('#timelineEventTypeSelect').on('change', function() {
            var selected = ($(this).val() || []).filter(function(v) { return v !== ""; });

            if (selected.length === 0) {
                $('.timeline-content span[data-type]').each(function() {
                    $(this).show();
                    var $prevHr = $(this).prev('hr');
                    if ($prevHr.length) $prevHr.show();
                });
                return;
            }

            $('.timeline-content span[data-type]').each(function() {
                var type = $(this).attr('data-type');
                var $prevHr = $(this).prev('hr');

                if (selected.includes(type)) {
                    $(this).show();
                    if ($prevHr.length) $prevHr.show();
                } else {
                    $(this).hide();
                    if ($prevHr.length) $prevHr.hide();
                }
            });
        });
    });
</script>
